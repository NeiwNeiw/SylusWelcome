<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Sylus Welcome Â· AR</title>

  <!-- A-Frame + MindAR -->
  <script src="https://unpkg.com/aframe@1.5.0/dist/aframe.min.js"></script>
  <script src="https://unpkg.com/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

  <style>
    :root { color-scheme: dark; }
    html, body { margin:0; height:100%; background:#000; font-family: system-ui, -apple-system, "Segoe UI", Arial; }
    .top {
      position: fixed; left: 12px; right: 12px; top: 12px;
      z-index: 9999; display:flex; gap:10px; align-items:stretch;
    }
    .panel {
      flex: 1;
      padding: 10px 12px; border-radius: 14px;
      background: rgba(0,0,0,.60); color:#fff; font-size: 13px; line-height: 1.45;
      backdrop-filter: blur(8px);
      border: 1px solid rgba(255,255,255,.08);
      max-height: 42vh; overflow:auto;
      white-space: pre-wrap; word-break: break-word;
    }
    .btn {
      position: fixed; left: 12px; right: 12px; bottom: 12px;
      z-index: 9999;
      border: 0; border-radius: 16px;
      padding: 14px 16px; font-size: 16px; font-weight: 800;
      background: rgba(255,255,255,.92); color:#000;
      cursor: pointer;
    }
    .btn:active { transform: translateY(1px); }
    .pill {
      display:inline-block; padding: 3px 8px; border-radius: 999px;
      background: rgba(255,255,255,.12); margin-right: 6px;
    }

    /* Video modal */
    .modal {
      position: fixed; inset: 0;
      display:none; align-items:center; justify-content:center;
      background: rgba(0,0,0,.75);
      z-index: 10000;
      padding: 18px;
    }
    .modal.open { display:flex; }
    .card {
      width: min(760px, 100%);
      background: rgba(20,20,20,.92);
      border-radius: 18px;
      overflow:hidden;
      box-shadow: 0 10px 40px rgba(0,0,0,.6);
    }
    .card header{
      display:flex; align-items:center; justify-content:space-between;
      padding: 12px 14px;
      color:#fff; font-weight: 800;
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .xbtn {
      appearance:none; border:0; border-radius: 12px;
      background: rgba(255,255,255,.12);
      color:#fff; padding: 8px 10px; cursor: pointer;
    }
    video { width:100%; height:auto; display:block; background:#000; }
    .note { padding: 10px 14px 14px; color: rgba(255,255,255,.75); font-size: 13px; line-height:1.5; }
  </style>
</head>

<body>
  <div class="top">
    <div class="panel" id="log">è¼‰å…¥ä¸­â€¦</div>
  </div>

  <button class="btn" id="startBtn">é–‹å§‹ç›¸æ©Ÿ</button>

  <!-- Video modal -->
  <div class="modal" id="modal" role="dialog" aria-modal="true" aria-label="æ­¡è¿å½±ç‰‡">
    <div class="card">
      <header>
        <div>æ­¡è¿ âœ¨</div>
        <button class="xbtn" id="closeBtn">é—œé–‰</button>
      </header>
      <video id="welcomeVideo" playsinline controls preload="metadata">
        <source src="./welcome.mp4" type="video/mp4" />
        ä½ çš„ç€è¦½å™¨ä¸æ”¯æ´å½±ç‰‡æ’­æ”¾
      </video>
      <div class="note">
        iPhone è‹¥ç„¡æ³•è‡ªå‹•æ’­æ”¾æ˜¯æ­£å¸¸çš„ï¼ˆSafari é™åˆ¶ï¼‰ï¼Œç›´æ¥æŒ‰æ’­æ”¾å³å¯ã€‚
      </div>
    </div>
  </div>

  <!-- AR Scene -->
  <a-scene
    mindar-image="imageTargetSrc: ./targets.mind; autoStart: false; uiScanning: yes; uiLoading: yes;"
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false"
    renderer="colorManagement: true, physicallyCorrectLights: true"
  >
    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
    <a-entity mindar-image-target="targetIndex: 0" id="marker"></a-entity>
  </a-scene>

  <script>
    const logEl = document.getElementById('log');
    const startBtn = document.getElementById('startBtn');
    const sceneEl = document.querySelector('a-scene');

    const marker = document.getElementById('marker');
    const modal = document.getElementById('modal');
    const closeBtn = document.getElementById('closeBtn');
    const video = document.getElementById('welcomeVideo');

    let opened = false;

    function log(msg) {
      const t = new Date().toLocaleTimeString();
      logEl.textContent = `[${t}] ${msg}\n` + logEl.textContent;
    }

    // æŠŠæ‰€æœ‰éŒ¯èª¤éƒ½å°å‡ºä¾†ï¼ˆä½ å°±ä¸æœƒè¦ºå¾—ã€Œæ²’åæ‡‰ã€ï¼‰
    window.addEventListener('error', (e) => {
      log(`âŒ error: ${e.message}`);
    });
    window.addEventListener('unhandledrejection', (e) => {
      const r = e.reason;
      log(`âŒ unhandledrejection: ${(r && (r.name || r.message)) ? `${r.name || ''} ${r.message || ''}` : String(r)}`);
    });

    function isInAppBrowser() {
      const ua = navigator.userAgent || '';
      return /Line|FBAV|FBAN|Instagram|Messenger|MicroMessenger/i.test(ua);
    }

    function openModal() {
      if (opened) return;
      opened = true;
      modal.classList.add('open');
      log('ğŸ¬ å½±ç‰‡å½ˆçª—é–‹å•Ÿ');

      try {
        video.currentTime = 0;
        const p = video.play();
        if (p && typeof p.catch === 'function') p.catch(() => log('â„¹ï¸ å½±ç‰‡ç„¡æ³•è‡ªå‹•æ’­æ”¾ï¼ˆiOS å¸¸è¦‹ï¼Œæ‰‹å‹•æŒ‰æ’­æ”¾å³å¯ï¼‰'));
      } catch (_) {}
    }

    function closeModal() {
      modal.classList.remove('open');
      try { video.pause(); } catch (_) {}
      opened = false;
      log('ğŸ§© å½±ç‰‡å½ˆçª—é—œé–‰');
    }
    closeBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });

    marker.addEventListener('targetFound', () => {
      log('âœ… targetFoundï¼šå·²è¾¨è­˜åˆ°é‚€è«‹å¡');
      openModal();
    });
    marker.addEventListener('targetLost', () => {
      log('ğŸ” targetLostï¼šçœ‹ä¸åˆ°é‚€è«‹å¡äº†');
    });

    async function forceCameraPermissionOnce() {
      log('ğŸ“· step1ï¼šå‘¼å« getUserMedia è¦æ±‚ç›¸æ©Ÿæ¬Šé™');
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: { ideal: 'environment' } },
        audio: false
      });
      log('âœ… step1ï¼šgetUserMedia æˆåŠŸï¼ˆå·²æ‹¿åˆ°ç›¸æ©Ÿä¸²æµï¼‰');
      stream.getTracks().forEach(t => t.stop());
      log('ğŸ›‘ step1ï¼šå·²åœæ­¢ä¸²æµï¼ˆäº¤çµ¦ MindAR æ¥æ‰‹ï¼‰');
    }

    async function ensureSceneLoaded() {
      if (sceneEl.hasLoaded) return;
      log('â³ step2ï¼šç­‰å¾… A-Frame scene loaded');
      await new Promise(res => sceneEl.addEventListener('loaded', res, { once: true }));
      log('âœ… step2ï¼šscene loaded');
    }

    startBtn.addEventListener('click', async () => {
      log('ğŸ‘‰ æŒ‰ä¸‹é–‹å§‹ç›¸æ©Ÿ');

      if (isInAppBrowser()) {
        log('âš ï¸ åµæ¸¬åˆ°å…§å»ºç€è¦½å™¨ï¼ˆLINE/IG/FB ç­‰ï¼‰å¯èƒ½æœƒæ“‹ç›¸æ©Ÿ');
      }

      try {
        // ç’°å¢ƒè³‡è¨Šå…ˆå°å‡ºä¾†
        log(`ğŸ”§ env: secureContext=${window.isSecureContext}, protocol=${location.protocol}`);
        log(`ğŸ”§ support: mediaDevices=${!!navigator.mediaDevices}, getUserMedia=${!!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia)}`);

        if (!window.isSecureContext) {
          throw new Error('éå®‰å…¨ç’°å¢ƒï¼ˆéœ€è¦ HTTPS æˆ– localhost æ‰èƒ½ç”¨ç›¸æ©Ÿï¼‰');
        }
        if (!navigator.mediaDevices?.getUserMedia) {
          throw new Error('æ­¤ç€è¦½å™¨ä¸æ”¯æ´ getUserMediaï¼ˆç„¡æ³•ä½¿ç”¨ç›¸æ©Ÿï¼‰');
        }

        // 1) å…ˆé€¼å‡ºç›¸æ©Ÿæ¬Šé™
        await forceCameraPermissionOnce();

        // 2) ç­‰ scene ready
        await ensureSceneLoaded();

        // 3) å•Ÿå‹• MindAR
        log('ğŸš€ step3ï¼šæº–å‚™å•Ÿå‹• mindar-image-system.start()');
        const mindarSystem = sceneEl.systems['mindar-image-system'];
        if (!mindarSystem) throw new Error('mindar-image-system ä¸å­˜åœ¨ï¼šMindAR script å¯èƒ½æ²’è¼‰å…¥æˆåŠŸ');

        await mindarSystem.start();
        log('âœ… step3ï¼šMindAR start å®Œæˆï¼ˆæ‡‰è©²å·²é–‹ç›¸æ©Ÿä¸¦é€²å…¥æƒæï¼‰');

        startBtn.textContent = 'ç›¸æ©Ÿå·²å•Ÿå‹• âœ… å°æº–é‚€è«‹å¡';
        startBtn.disabled = true;
        startBtn.style.opacity = '0.7';

      } catch (e) {
        const name = e?.name ? `${e.name}: ` : '';
        const msg = e?.message || String(e);
        log(`âŒ å•Ÿå‹•å¤±æ•—ï¼š${name}${msg}`);

        // å¸¸è¦‹ç‹€æ³è£œå……
        if ((e?.name || '').includes('NotAllowed')) {
          log('â¡ï¸ å¤šåŠæ˜¯æ¬Šé™æ‹’çµ•æˆ–è¢«å…§å»ºç€è¦½å™¨æ“‹ï¼šè«‹ç”¨ Safari/Chrome é–‹å•Ÿä¸¦å…è¨±ç›¸æ©Ÿ');
        }
        if ((e?.name || '').includes('NotFound')) {
          log('â¡ï¸ å¤šåŠæ˜¯æ‰¾ä¸åˆ°ç›¸æ©Ÿæˆ–ç›¸æ©Ÿè¢«å…¶ä»– App ä½”ç”¨');
        }
      }
    });

    log('âœ… é é¢è¼‰å…¥å®Œæˆ');
    log(`â„¹ï¸ userAgent: ${navigator.userAgent}`);
    if (isInAppBrowser()) {
      log('âš ï¸ ä½ ç¾åœ¨çœ‹èµ·ä¾†æ˜¯åœ¨ã€Œå…§å»ºç€è¦½å™¨ã€é–‹å•Ÿï¼Œå¼·çƒˆå»ºè­°ç”¨ Safari/Chrome å¤–é–‹ã€‚');
    }
  </script>
</body>
</html>