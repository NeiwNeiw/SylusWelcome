<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>SylusWelcome Â· AR</title>

  <!-- âœ… æ”¹ç”¨è¼ƒç©©çš„ A-Frame ç‰ˆæœ¬ -->
  <script src="https://unpkg.com/aframe@1.4.2/dist/aframe.min.js"></script>
  <script src="https://unpkg.com/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

  <style>
    :root{color-scheme:dark}
    html,body{margin:0;height:100%;background:#000;font-family:system-ui,-apple-system,"Segoe UI",Arial}
    .panel{
      position:fixed;left:12px;right:12px;top:12px;z-index:9999;
      padding:10px 12px;border-radius:14px;background:rgba(0,0,0,.60);
      border:1px solid rgba(255,255,255,.08);backdrop-filter:blur(8px);
      color:#fff;font-size:13px;line-height:1.45;max-height:45vh;overflow:auto;
      white-space:pre-wrap;word-break:break-word;
    }
    .btn{
      position:fixed;left:12px;right:12px;bottom:12px;z-index:9999;
      border:0;border-radius:16px;padding:14px 16px;font-size:16px;font-weight:800;
      background:rgba(255,255,255,.92);color:#000;cursor:pointer;
    }
    .btn:active{transform:translateY(1px)}
    .modal{
      position:fixed;inset:0;display:none;align-items:center;justify-content:center;
      background:rgba(0,0,0,.75);z-index:10000;padding:18px;
    }
    .modal.open{display:flex}
    .card{
      width:min(760px,100%);background:rgba(20,20,20,.92);
      border-radius:18px;overflow:hidden;box-shadow:0 10px 40px rgba(0,0,0,.6);
    }
    .card header{
      display:flex;align-items:center;justify-content:space-between;
      padding:12px 14px;color:#fff;font-weight:800;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .xbtn{
      appearance:none;border:0;border-radius:12px;background:rgba(255,255,255,.12);
      color:#fff;padding:8px 10px;cursor:pointer;
    }
    video{width:100%;height:auto;display:block;background:#000}
    .note{padding:10px 14px 14px;color:rgba(255,255,255,.75);font-size:13px;line-height:1.5}
  </style>
</head>

<body>
  <div class="panel" id="log">è¼‰å…¥ä¸­â€¦</div>
  <button class="btn" id="startBtn">é–‹å§‹ç›¸æ©Ÿ</button>

  <!-- Video modal -->
  <div class="modal" id="modal" role="dialog" aria-modal="true" aria-label="æ­¡è¿å½±ç‰‡">
    <div class="card">
      <header>
        <div>æ­¡è¿ âœ¨</div>
        <button class="xbtn" id="closeBtn">é—œé–‰</button>
      </header>
      <video id="welcomeVideo" playsinline controls preload="metadata">
        <source src="./welcome.mp4" type="video/mp4" />
        ä½ çš„ç€è¦½å™¨ä¸æ”¯æ´å½±ç‰‡æ’­æ”¾
      </video>
      <div class="note">iPhone è‹¥ç„¡æ³•è‡ªå‹•æ’­æ”¾æ­£å¸¸ï¼ŒæŒ‰æ’­æ”¾éµå³å¯ã€‚</div>
    </div>
  </div>

  <!-- âœ… åŠ  embedded + ç°¡åŒ– rendererï¼Œé¿å…æŸäº› Safari åˆå§‹åŒ–å¡ä½ -->
  <a-scene
    embedded
    loading-screen="enabled:false"
    renderer="antialias: true; alpha: true"
    vr-mode-ui="enabled:false"
    device-orientation-permission-ui="enabled:false"
    mindar-image="imageTargetSrc: ./targets.mind; autoStart: false; uiScanning: yes; uiLoading: yes;"
  >
    <a-camera position="0 0 0" look-controls="enabled:false"></a-camera>
    <a-entity mindar-image-target="targetIndex: 0" id="marker"></a-entity>
  </a-scene>

  <script>
    const logEl = document.getElementById('log');
    const startBtn = document.getElementById('startBtn');
    const sceneEl = document.querySelector('a-scene');
    const marker = document.getElementById('marker');

    const modal = document.getElementById('modal');
    const closeBtn = document.getElementById('closeBtn');
    const video = document.getElementById('welcomeVideo');
    let opened = false;

    function log(msg){
      const t = new Date().toLocaleTimeString();
      logEl.textContent = `[${t}] ${msg}\n` + logEl.textContent;
    }

    window.addEventListener('error', e => log(`âŒ error: ${e.message}`));
    window.addEventListener('unhandledrejection', e => {
      const r = e.reason;
      log(`âŒ unhandledrejection: ${r?.name || ''} ${r?.message || String(r)}`);
    });

    // âœ… WebGL è‡ªæª¢ï¼šå¦‚æœé€™è£¡å¤±æ•—ï¼ŒA-Frame å¾ˆå¯èƒ½æ°¸é ä¸æœƒ loaded
    function webglCheck(){
      const c = document.createElement('canvas');
      const gl = c.getContext('webgl') || c.getContext('experimental-webgl');
      return !!gl;
    }

    function openModal(){
      if(opened) return;
      opened = true;
      modal.classList.add('open');
      log('ğŸ¬ æ‰“é–‹å½±ç‰‡å½ˆçª—');
      try{
        video.currentTime = 0;
        const p = video.play();
        if(p && p.catch) p.catch(()=>log('â„¹ï¸ å½±ç‰‡ç„¡æ³•è‡ªå‹•æ’­æ”¾ï¼ˆiOS å¸¸è¦‹ï¼‰'));
      }catch(_){}
    }
    function closeModal(){
      modal.classList.remove('open');
      try{ video.pause(); }catch(_){}
      opened = false;
      log('ğŸ§© é—œé–‰å½±ç‰‡å½ˆçª—');
    }
    closeBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', e => { if(e.target===modal) closeModal(); });

    marker.addEventListener('targetFound', ()=>{ log('âœ… targetFoundï¼šè¾¨è­˜åˆ°é‚€è«‹å¡'); openModal(); });
    marker.addEventListener('targetLost', ()=>{ log('ğŸ” targetLostï¼šçœ‹ä¸åˆ°é‚€è«‹å¡'); });

    // âœ… ä¸å†å‚»ç­‰ loadedï¼šæœ€å¤šç­‰ 3 ç§’ï¼Œç­‰ä¸åˆ°å°±ç›´æ¥å‘Šè¨´ä½ å¡åœ¨å“ª
    async function waitSceneReady(timeoutMs = 3000){
      if(sceneEl.hasLoaded) return true;

      const p = new Promise(res => sceneEl.addEventListener('loaded', ()=>res(true), {once:true}));
      const t = new Promise(res => setTimeout(()=>res(false), timeoutMs));
      return await Promise.race([p, t]);
    }

    async function forceCameraPermissionOnce(){
      log('ğŸ“· step1ï¼šgetUserMedia è¦æ±‚ç›¸æ©Ÿæ¬Šé™');
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: { ideal:'environment' } },
        audio: false
      });
      log('âœ… step1ï¼šgetUserMedia æˆåŠŸ');
      stream.getTracks().forEach(t=>t.stop());
      log('ğŸ›‘ step1ï¼šåœæ­¢ä¸²æµï¼ˆäº¤çµ¦ MindARï¼‰');
    }

    startBtn.addEventListener('click', async ()=>{
      log('ğŸ‘‰ æŒ‰ä¸‹é–‹å§‹ç›¸æ©Ÿ');
      log(`ğŸ”§ env: secureContext=${window.isSecureContext}, protocol=${location.protocol}`);
      log(`ğŸ”§ webgl: ${webglCheck() ? 'OK' : 'FAIL'}`);
      log(`ğŸ”§ support: mediaDevices=${!!navigator.mediaDevices}, getUserMedia=${!!navigator.mediaDevices?.getUserMedia}`);

      try{
        if(!window.isSecureContext) throw new Error('é HTTPSï¼ˆéœ€è¦å®‰å…¨ç’°å¢ƒï¼‰');
        if(!navigator.mediaDevices?.getUserMedia) throw new Error('ä¸æ”¯æ´ getUserMedia');

        if(!webglCheck()){
          throw new Error('WebGL åˆå§‹åŒ–å¤±æ•—ï¼ˆA-Frame å¯èƒ½ç„¡æ³•å•Ÿå‹•ï¼‰ã€‚è«‹åˆ°ï¼šè¨­å®šâ†’Safariâ†’é€²éšï¼Œç¢ºèª WebGL æ²’è¢«é™åˆ¶ï¼›æˆ–é‡é–‹ Safari/é‡é–‹æ©Ÿå†è©¦ã€‚');
        }

        await forceCameraPermissionOnce();

        log('â³ step2ï¼šç­‰å¾… A-Frame scene loadedï¼ˆæœ€å¤š 3 ç§’ï¼‰');
        const ok = await waitSceneReady(3000);
        if(!ok){
          throw new Error('A-Frame scene æ²’æœ‰é€²å…¥ loadedï¼ˆiOS Safari å¸¸è¦‹å¡é»ï¼‰ã€‚å·²æ”¹ç”¨ aframe@1.4.2 ä»å¤±æ•—çš„è©±ï¼Œé€šå¸¸æ˜¯ WebGL/è³‡æºè¼‰å…¥è¢«æ“‹ã€‚');
        }
        log('âœ… step2ï¼šscene loaded');

        log('ğŸš€ step3ï¼šmindar-image-system.start()');
        const mindarSystem = sceneEl.systems['mindar-image-system'];
        if(!mindarSystem) throw new Error('mindar-image-system ä¸å­˜åœ¨ï¼ˆMindAR script æ²’è¼‰åˆ°æˆ–è¢«æ“‹ï¼‰');

        await mindarSystem.start();
        log('âœ… step3ï¼šMindAR å·²å•Ÿå‹•ï¼ˆé–‹å§‹æƒæï¼‰');

        startBtn.textContent = 'ç›¸æ©Ÿå·²å•Ÿå‹• âœ… å°æº–é‚€è«‹å¡';
        startBtn.disabled = true;
        startBtn.style.opacity = '0.7';
      }catch(e){
        log(`âŒ å•Ÿå‹•å¤±æ•—ï¼š${e?.name ? e.name+': ' : ''}${e?.message || String(e)}`);
      }
    });

    log('âœ… é é¢è¼‰å…¥å®Œæˆ');
    log(`â„¹ï¸ userAgent: ${navigator.userAgent}`);
  </script>
</body>
</html>